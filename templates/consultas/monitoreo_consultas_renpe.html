<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Monitoreo de Consultas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body class="bg-light">

<div class="container mt-5">
    <h2 class="mb-4 text-center">Monitoreo de Consultas ReNPE</h2>

    <!-- Botones arriba -->
    <div class="mb-3 d-flex justify-content-between align-items-center">
        <button class="btn btn-secondary" onclick="history.back();">‚Üê Regresar</button>

        <!-- Rango de fechas y bot√≥n exportar -->
        <div class="d-flex align-items-center">
            <label class="me-2">Desde:</label>
            <input type="date" id="fechaDesde" class="form-control form-control-sm me-3">
            <label class="me-2">Hasta:</label>
            <input type="date" id="fechaHasta" class="form-control form-control-sm me-3">
            <button class="btn btn-success" id="btnExportar">
                üìä Exportar Excel
            </button>
        </div>
    </div>

    <!-- Tabla -->
    <table id="tablaConsultas" class="table table-striped table-bordered display">
        <thead class="table-dark">
            <tr>
                <th>Fecha</th>
                <th>CUEANEXO</th>
                <th>Nombre</th>
                <th>Regional</th>
                <th>M√≥dulo</th>
                <th>Email</th>
                <th>Mensaje</th>
                <th>Estado</th>
                <th>Acci√≥n</th>
            </tr>
        </thead>
        <tbody>
            {% for c in consultas %}
            <tr id="fila-{{ c.id }}">
                <td>{{ c.fecha|date:"d/m/Y H:i" }}</td>
                <td>{{ c.cueanexo }}</td>
                <td>{{ c.apellido_nombre }}</td>
                <td>{{ c.regional }}</td>
                <td>{{ c.renpe_modulo }}</td>
                <td>{{ c.email }}</td>
                <td>{{ c.mensaje }}</td>
                <td id="estado-{{ c.id }}">
                    {{ c.estado }}
                    {% if c.estado == "Solucionado" and c.estado_usuario %}
                        <br><small>{{ c.estado_usuario }} - {{ c.estado_fecha|date:"d/m/Y H:i" }}</small>
                    {% endif %}
                </td>
                <td>
                    {% if c.estado == "Pendiente" %}
                    <button class="btn btn-success btn-sm actualizar-estado-renpe" data-id="{{ c.id }}">Marcar Solucionado</button>
                    {% else %}
                    <span class="text-success">‚úî Solucionado</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Moment.js y plugin para ordenar fechas -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/locale/es.min.js"></script>
<script src="https://cdn.datatables.net/plug-ins/1.13.6/sorting/datetime-moment.js"></script>

<script>
$(document).ready(function() {
    // Registrar formato de fecha con moment.js
    $.fn.dataTable.moment('DD/MM/YYYY HH:mm');
    
    // Inicializar DataTable
    $('#tablaConsultas').DataTable({
        language: {
            url: 'https://cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json'
        },
        pageLength: 10,
        order: [[0, 'desc']]
    });

    // Cambiar estado v√≠a AJAX
    $('.actualizar-estado-renpe').click(function(){
        let consultaId = $(this).data('id');
        let boton = $(this);

        $.ajax({
            url: "{% url 'consultas_api:actualizar_estado_renpe' 0 %}".replace('0', consultaId),
            type: "POST",
            headers: {'X-CSRFToken': '{{ csrf_token }}'},
            success: function(response){
                if(response.status === 'success'){
                    $('#estado-' + consultaId).html(
                        response.nuevo_estado + '<br><small>' + response.usuario + ' - ' + response.fecha + '</small>'
                    );
                    boton.replaceWith('<span class="text-success">‚úî Solucionado</span>');
                    Swal.fire('¬°Actualizado!', 'El estado ha sido cambiado a Solucionado.', 'success');
                } else {
                    Swal.fire('Error', response.message, 'error');
                }
            },
            error: function(){
                Swal.fire('Error', 'Ocurri√≥ un error inesperado.', 'error');
            }
        });
    });

    // Exportar Excel
    $('#btnExportar').click(function() {
        let desde = $('#fechaDesde').val();
        let hasta = $('#fechaHasta').val();

        if(!desde || !hasta){
            Swal.fire('Atenci√≥n', 'Debes seleccionar ambas fechas.', 'warning');
            return;
        }

        let url = "{% url 'consultas_api:exportar_excel_renpe' %}" + "?desde=" + desde + "&hasta=" + hasta;
        window.location.href = url;
    });
});
</script>

</body>
</html>

