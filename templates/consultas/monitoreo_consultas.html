<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Monitoreo de Consultas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body class="bg-light">

<div class="container mt-5">
    <h2 class="mb-4 text-center">Monitoreo de Consultas SGE</h2>

    <!-- Botón regresar -->
    <div class="mb-3">
        <button class="btn btn-secondary" onclick="history.back();">← Regresar</button>
    </div>

    <table id="tablaConsultas" class="table table-striped table-bordered display">
        <thead class="table-dark">
            <tr>
                <th>Fecha</th>
                <th>CUEANEXO</th>
                <th>Nombre</th>
                <th>Regional</th>
                <th>Nivel</th>
                <th>Módulo</th>
                <th>Email</th>
                <th>Mensaje</th>
                <th>Estado</th>
                <th>Acción</th>
            </tr>
        </thead>
        <tbody>
            {% for c in consultas %}
            <tr id="fila-{{ c.id }}">
                <td>{{ c.fecha|date:"d/m/Y H:i" }}</td>
                <td>{{ c.cueanexo }}</td>
                <td>{{ c.apellido_nombre }}</td>
                <td>{{ c.regional }}</td>
                <td>{{ c.nivel_modalidad }}</td>
                <td>{{ c.sge_modulo }}</td>
                <td>{{ c.email }}</td>
                <td>{{ c.mensaje }}</td>
                <td id="estado-{{ c.id }}">
                    {{ c.estado }}
                    {% if c.estado == "Solucionado" and c.estado_usuario %}
                        <br><small>{{ c.estado_usuario }} - {{ c.estado_fecha|date:"d/m/Y H:i" }}</small>
                    {% endif %}
                </td>
                <td>
                    {% if c.estado == "Pendiente" %}
                    <button class="btn btn-success btn-sm actualizar-estado" data-id="{{ c.id }}">Marcar Solucionado</button>
                    {% else %}
                    <span class="text-success">✔ Solucionado</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
$(document).ready(function() {
    // Inicializar DataTable
    $('#tablaConsultas').DataTable({
        language: {
            url: 'https://cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json'
        },
        pageLength: 10,
        order: [[0, 'desc']]
    });

    // Cambiar estado vía AJAX
    $('.actualizar-estado').click(function(){
        let consultaId = $(this).data('id');
        let boton = $(this);

        $.ajax({
            url: "{% url 'consultas_api:actualizar_estado' 0 %}".replace('0', consultaId),
            type: "POST",
            headers: {'X-CSRFToken': '{{ csrf_token }}'},
            success: function(response){
                if(response.status === 'success'){
                    // Actualiza estado con usuario y fecha
                    $('#estado-' + consultaId).html(
                        response.nuevo_estado + '<br><small>' + response.usuario + ' - ' + response.fecha + '</small>'
                    );
                    // Reemplaza botón con texto ✔ Solucionado
                    boton.replaceWith('<span class="text-success">✔ Solucionado</span>');
                    Swal.fire('¡Actualizado!', 'El estado ha sido cambiado a Solucionado.', 'success');
                } else {
                    Swal.fire('Error', response.message, 'error');
                }
            },
            error: function(){
                Swal.fire('Error', 'Ocurrió un error inesperado.', 'error');
            }
        });
    });
});
</script>

</body>
</html>
