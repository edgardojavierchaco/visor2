{% extends 'dashboard/body.html' %}

{% load static %}

{% block content %}
    <head>
        <title>Mapa</title>        
        <!-- Bootstrap5 CSS -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
        <!-- Bootstrap Bundle JS -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
        <!-- Popper JS -->
        <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js" integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p" crossorigin="anonymous"></script>
        <!-- Leaflet CSS -->
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="">
        <!-- Leaflet JS -->
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
        <!-- Leaflet Draw JS -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js" integrity="sha512-ozq8xQKq6urvuU6jNgkfqAmT7jKN2XumbrX1JiB3TnF7tI48DPI4Gy1GXKD/V3EExgAs1V+pRO7vwtS1LHg0Gw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
        <!-- Leaflet Draw CSS -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" integrity="sha512-gc3xjCmIy673V6MyOAZhIW93xhM9ei1I+gLbmFjUHIjocENRsLX/QUE1htk5q1XV2D/iie/VQ8DXI6Vu8bexvQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
        <!-- Leaflet EasyButton CSS -->
        <link rel="stylesheet" href="https://unpkg.com/leaflet-easybutton/src/easy-button.css" />
        <!-- Leaflet EasyButton JS -->
        <script src="https://unpkg.com/leaflet-easybutton/src/easy-button.js"></script>
        <!---Leaflet Area selection-->
        <link rel="stylesheet" href="https://unpkg.com/@bopen/leaflet-area-selection/dist/index.css" />
        <!-- Font Awesome CSS -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
        <!-- DataTables Bootstrap 5 CSS -->
        <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
        <!-- Leaflet Control Geocoder CSS -->
        <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
        <!-- Leaflet Control Geocoder JS -->
        <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
        <!-- Leaflet Routing Machine CSS -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet-routing-machine/3.2.12/leaflet-routing-machine.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"> 
        <style>
            #map {
                height: 500px;
            }
           
        </style>
    </head>
    <body>
    <div class="align-center"><h1 class="text-center">B칔SQUEDA DE ESTABLECIMIENTOS</h1></div>
    <div id='map-container'>
        <div id="map"></div>
    </div>
    <div id="marker-table-container">
        <table id="markersTable" class="display">
            <thead>
                <tr>
                    <th>Cueanexo</th>
                    <th>Establecimiento</th>
                    <th>Oferta</th>
                    <th>Ambito</th>
                    <th>Regi칩n</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>

    <!-- Agrega el enlace al archivo JavaScript de DataTables -->
    <script src='https://code.jquery.com/jquery-3.7.0.js'></script>
    <script src='https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js'></script>
    <script src='https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js'></script>
    <script src='https://cdn.datatables.net/buttons/2.0.0/js/dataTables.buttons.min.js'></script>
    <script src='https://cdn.datatables.net/buttons/2.0.0/js/buttons.print.min.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.0.1/js/buttons.html5.min.js"></script>
    <!-- Lenguaje para los botones -->
    <script src="https://cdn.datatables.net/buttons/2.0.1/js/buttons.colVis.min.js"></script>
    <!-- Leaflet Routing Machine JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-routing-machine/3.2.12/leaflet-routing-machine.js"></script>

    <script src="https://unpkg.com/@bopen/leaflet-area-selection/dist/index.umd.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@latest/turf.min.js"></script>

    <script>
        // Espera a que el documento est칠 listo
        document.addEventListener('DOMContentLoaded', function() {
            var map = L.map('map').setView([-25.388415775410138, -60.99025493373542], 8);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            
            var markersTable;

            var geojsonFeature = {{ geojson_data|safe }};
            
            var geojsonLayer=L.geoJSON(geojsonFeature, {
                onEachFeature: function (feature, layer) {
                    layer.bindPopup('<p>Cueanexo: <a href="#" onclick="filterTable(\'' + feature.properties.cueanexo + '\',\'' + feature.properties.oferta + '\')">' + feature.properties.cueanexo + '</a></p>' +
                                    '<p>Establecimiento: <strong>' + feature.properties.nom_est + '</strong></h4>' + 
                                    '<p>Oferta: ' + feature.properties.oferta + '</p>' +
                                    '<p>Ambito: ' + feature.properties.ambito + '</p>' +
                                    '<p>Regi칩n: ' + feature.properties.region_loc + '</p>' +
                                    '<p>Latitud: ' + feature.geometry.coordinates[1] + '</p>'+
                                    '<p>Longitud: ' + feature.geometry.coordinates[0] + '</p>');
                    
                }
            });

            // Iterar sobre cada feature en el objeto GeoJSON
            geojsonFeature.features.forEach(function(feature) {
                // Verificar si la geometr칤a es un punto
                if (feature.geometry.type === "Point") {
                    // Extraer las coordenadas (latitud y longitud) del punto
                    var latitud = feature.geometry.coordinates[1]; // El 칤ndice 1 corresponde a la latitud
                    var longitud = feature.geometry.coordinates[0]; // El 칤ndice 0 corresponde a la longitud
                    
                    // Aqu칤 puedes usar latitud y longitud como desees
                    console.log("Latitud:", latitud);
                    console.log("Longitud:", longitud);
                }
            });

            // Agrega la funcionalidad de dibujo al mapa
            let drawnItems = new L.FeatureGroup();
            map.addLayer(drawnItems);

            let drawControl = new L.Control.Draw({
                edit: {
                    featureGroup: drawnItems,
                    edit: {
                        title: 'Editar elementos',
                        edit: true,
                        save: true,
                        cancel: true,
                        remove: true
                    },
                    
                },
                draw: {
                    polyline: false,
                    marker: true,
                    circlemarker: true,
                    circle: true,
                    rectangle: true,
                    polygon: {
                        shapeOptions: {
                            color: 'green'
                        },
                        showArea: true,
                        allowIntersection: false,
                        drawError: {
                            color: '#b00b00',
                            timeout: 1000
                        },
                        repeatMode: false, // Esto evita que se dibujen m칰ltiples pol칤gonos seguidos sin cerrarlo
                        finishOn: 'click'
                    }   
                },
                locateButton: { // Agrega un bot칩n personalizado
                    title: "Encuentra cercanos", // T칤tulo del bot칩n
                    text: "Encuentra cercanos", // Texto del bot칩n
                    icon: { html: "游늸" }, // Icono del bot칩n (puedes personalizarlo)
                },
                position: 'topright',
            });
            map.addControl(drawControl);

            
            // Crea un bot칩n personalizado para resetear la vista
            var resetViewButton = L.easyButton({
                states: [{
                    stateName: 'reset-view',
                    icon: 'fa fa-refresh fa-spin', // Icono para el bot칩n de reset
                    title: 'Restablecer Vista', // T칤tulo o descripci칩n del bot칩n de reset
                    onClick: function (control) {
                        // Recargar la p치gina
                        location.reload();
                    },
                }],
            });
            resetViewButton.addTo(map); // Agrega el bot칩n de reset al mapa

            /* Agrega el control de b칰squeda de direcciones
            L.Control.geocoder().addTo(map); */

            // Funci칩n para encontrar marcadores cercanos en un radio de 1000 metros
            function findNearbyMarkers(latlng) {
                var nearbyMarkers = [];
                
                // Iterar sobre los marcadores existentes
                geojsonLayer.eachLayer(function(layer) {
                    // Calcular la distancia entre el marcador actual y el marcador de referencia
                    var distance = latlng.distanceTo(layer.getLatLng());

                    // Si el marcador actual est치 dentro del radio de 1000 metros, agr칠galo a la lista de marcadores cercanos
                    if (distance <= 500) {
                        nearbyMarkers.push(layer);
                    }
                });
                
                return nearbyMarkers;
            }

            // Agrega el control de b칰squeda de direcciones
            var geocoderControl = L.Control.geocoder({
                defaultMarkGeocode: false,
                placeholder: "Ingrese una direcci칩n (Ej. Avenida 9 de Julio 555, Resistencia)"
            }).addTo(map);

            // Evento que se activa al seleccionar una direcci칩n
            geocoderControl.on('markgeocode', function(event) {
                // Obtener las coordenadas de la direcci칩n seleccionada
                var latlng = event.geocode.center;

                // Crear un marcador en las coordenadas de la direcci칩n seleccionada
                var selectedMarker = L.marker(latlng, { icon: redIcon }).addTo(map);
                
                // Encontrar marcadores cercanos en un radio de 500 metros y agregarlos al mapa
                var nearbyMarkers = findNearbyMarkers(latlng);
                nearbyMarkers.forEach(function(nearbyMarker) {
                    nearbyMarker.addTo(map);
                });
                // Centrar el mapa en las coordenadas de la direcci칩n seleccionada
                map.setView(latlng, 17); // Ajusta el zoom seg칰n lo desees
            });

            // Define el icono rojo para el marcador seleccionado
            var redIcon = new L.Icon({
                iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            });

            // Define el icono azul para el resto de los marcadores
            var blueIcon = new L.Icon({
                iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            });

            // Captura el evento de dibujo terminado
            map.on(L.Draw.Event.CREATED, function(event) {
                var layer = event.layer;
                drawnItems.addLayer(layer);
                
                // Reinicia la tabla DataTable si ya existe
                if (markersTable) {
                    markersTable.destroy();
                }

                // Crea la tabla DataTable
                markersTable = $('#markersTable').DataTable({
                    responsive: true,
                    autoWidth: false,
                    language: {
                        url: "https://cdn.datatables.net/plug-ins/2.0.3/i18n/es-AR.json" // Ruta al archivo de traducci칩n en espa침ol
                    },      
                    dom: '<"top"lBf>rt<"bottom"ip>',
                    buttons: [
                        {
                            extend: 'excel',
                            text: '<i class="fas fa-file-excel"></i>',
                            className: 'btn btn-secondary',
                            exportOptions: {
                                columns: ':visible'
                            },
                            titleAttr: 'Exportar a Excel',
                            title: 'Nombre_del_archivo'
                        },
                        {
                            extend: 'csv',
                            text: '<i class="fas fa-file-csv"></i>',
                            className: 'btn btn-secondary',
                            exportOptions: {
                                columns: ':visible'
                            },
                            titleAttr: 'Exportar a CSV',
                            title: 'Nombre_del_archivo'
                        },
                        {
                            extend: 'pdf',
                            text: '<i class="fas fa-file-pdf"></i>',
                            className: 'btn btn-secondary',
                            exportOptions: {
                                columns: ':visible'
                            },
                            titleAttr: 'Exportar a PDF',
                            title: 'Nombre_del_archivo'
                        },
                        {
                            extend: 'print',
                            text: '<i class="fas fa-print"></i>',
                            className: 'btn btn-secondary',
                            exportOptions: {
                                columns: ':visible'
                            },
                            titleAttr: 'Imprimir',
                            title: 'Nombre_del_archivo'
                        }
                    ]
                });

                // Reinicia la matriz de puntos dentro del 치rea
                var pointsInsideArea = [];

                // Itera sobre los marcadores y verifica si est치n dentro de la forma dibujada
                geojsonLayer.eachLayer(function(marker) {
                    if (isMarkerInsideShape(marker, layer)) {
                        pointsInsideArea.push(marker.feature);
                        marker.addTo(map); // Agrega el marcador al mapa
                    }
                });

                // Agrega los datos a la tabla DataTable
                pointsInsideArea.forEach(function(point) {
                    markersTable.row.add([
                        '<a href="#" onclick="filterTable(\'' + point.properties.cueanexo + '\',\'' + point.properties.oferta + '\')">' + point.properties.cueanexo + '</a></td>',
                        point.properties.nom_est,
                        point.properties.oferta,
                        point.properties.ambito,
                        point.properties.region_loc
                    ]).draw();
                });

                // Muestra la tabla
                $('#markersTable').parent().show();
            });
            
            // Funci칩n para verificar si un punto est치 dentro de una forma
            function isMarkerInsideShape(marker, shape) {
                if (shape instanceof L.Circle) {
                    return shape.getBounds().contains(marker.getLatLng());
                } else if (shape instanceof L.Rectangle) {
                    return shape.getBounds().contains(marker.getLatLng());
                } else if (shape instanceof L.Polygon) {
                    return shape.getBounds().contains(marker.getLatLng());
                }
                return false;
            }

            // Evento que se activa al presionar la tecla ESC
            document.addEventListener('keydown', function(event) {
                if (event.keyCode === 27) { // Tecla ESC (c칩digo 27)
                    // Obtener el 칰ltimo pol칤gono dibujado
                    var lastPolygonLayer = drawnItems.getLayers().slice(-1)[0];
                    
                    // Verificar si hay al menos un pol칤gono dibujado
                    if (lastPolygonLayer) {
                        // Obtener los puntos del pol칤gono
                        var polygonPoints = lastPolygonLayer.getLatLngs();
                        
                        // Cerrar el pol칤gono uni칠ndolo con el primer punto
                        polygonPoints.push(polygonPoints[0]);
                        
                        // Actualizar los puntos del pol칤gono
                        lastPolygonLayer.setLatLngs(polygonPoints);
                        
                        // Filtrar los marcadores dentro del pol칤gono
                        drawnItems.eachLayer(function(layer) {
                            if (layer instanceof L.Marker && isMarkerInsideShape(layer, lastPolygonLayer)) {
                                layer.addTo(map); // Agregar el marcador al mapa
                            }
                        });
                    }
                }
            });
            
            // Define las capas de mosaico y sat칠lite
                var openStreetMap = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors',
                    maxZoom: 18,
                });
                var esriSatellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    attribution: 'Tiles &copy; Esri',
                    maxZoom: 8
                });

                // A침ade las capas al control de capas
                var baseLayers = {
                    "Mosaico": openStreetMap,
                    "Sat칠lite": esriSatellite
                };
                L.control.layers(baseLayers).addTo(map);
                openStreetMap.addTo(map); // A침ade una capa por defecto al mapa
            
        });
    </script>   
    <script>
        function filterTable(cueanexo, oferta) {
                // Redireccionar a la nueva p치gina y pasar el par치metro 'cueanexo' en la URL
                window.location.href = '/map/listados/?cueanexo=' + cueanexo + '&oferta='+oferta;
                console.log("Cueanexo:", cueanexo);
                console.log("Oferta:", oferta);
            }

    </script>
    </body>
{% endblock %}


