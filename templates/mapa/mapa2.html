{% load static %}
<!DOCTYPE html>
<html>
<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js" integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js" integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://npmcdn.com/@turf/turf@6.5.0/turf.min.js"></script>
    <script src="http://mapa.educacion.gob.ar/content/themes/poncho/js/leaflet.draw.js"></script>
    <!-- Corrección de los atributos rel aquí -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    <script src="https://cdn.datatables.net/plug-ins/2.0.3/i18n/es-AR.json"></script>
    <style>
        body {
            padding: 0;
            margin: 0;
        }
        html, body, #map {
            height: 87%;
            width: 100%;
        }
    </style>
</head>
<body>
    <div><h1 class="text-center">BÚSQUEDA DE ESTABLECIMIENTOS</h1></div>
    
    <div id='map'></div>
    
    <table id='table' class='display' style='width:100%'>
        <thead>
            <tr>
                <th scope='col'>CUEANEXO</th>
                <th scope='col'>NOMBRE</th>
                <th scope='col'>ÁMBITO</th>
                <th scope='col'>DEPARTAMENTO</th>
                <th scope='col'>REGION</th> <!-- Cambiado de 'region_loc' a 'region' -->
            </tr>
        </thead>
        <tbody id='lista'> 
        </tbody>
    </table>
    
    <script src='https://code.jquery.com/jquery-3.7.0.js'></script>
    <script src='https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js'></script>
    <script src='https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js'></script>
    <script>
        // Configura el idioma de DataTables en español
        $.extend(true, $.fn.dataTable.defaults, {
            language: {
                "sProcessing": "Procesando...",
                "sLengthMenu": "Mostrar _MENU_ registros",
                "sZeroRecords": "No se encontraron resultados",
                "sEmptyTable": "Ningún dato disponible en esta tabla",
                "sInfo": "Mostrando registros del _START_ al _END_ de un total de _TOTAL_ registros",
                "sInfoEmpty": "Mostrando registros del 0 al 0 de un total de 0 registros",
                "sInfoFiltered": "(filtrado de un total de _MAX_ registros)",
                "sInfoPostFix": "",
                "sSearch": "Buscar:",
                "sUrl": "",
                "sInfoThousands": ",",
                "sLoadingRecords": "Cargando...",
                "oPaginate": {
                    "sFirst": "Primero",
                    "sLast": "Último",
                    "sNext": "Siguiente",
                    "sPrevious": "Anterior"
                },
                "oAria": {
                    "sSortAscending": ": Activar para ordenar la columna de manera ascendente",
                    "sSortDescending": ": Activar para ordenar la columna de manera descendente"
                }
            }
        });

        // Configura DataTables para habilitar la paginación, ordenación y búsqueda
        $(document).ready(function() {
            $('#table').DataTable({
                "paging": true,
                "ordering": true,
                "searching": true
            });
        });
    </script>

  <script>
    let map = L.map("map", {
        center: [-25.388415775410138, -60.99025493373542],
        zoom: 6.5
    });

    var capa = L.tileLayer(
        "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
        { attribution: "&copy; OpenStreetMap" }
    ).addTo(map);

    let drawnItems = L.featureGroup();
    map.addLayer(drawnItems);

    let drawControl = new L.Control.Draw({
        edit: {
            featureGroup: drawnItems,
            edit: true
        },
        draw: {
            polygon: {
                allowIntersection: false,
                drawError: {
                    color: '#b00b00',
                    timeout: 1000
                },
                shapeOptions: {
                    color: '#23bfc2'
                },
            },
            marker: false,
            circlemarker: false,
            rectangle: false,
            circle: {
                allowIntersection: false,
                drawError: {
                    color: '#b00b00',
                    timeout: 1000
                },
                shapeOptions: {
                    color: '#23bfc2'
                },
            },
            polyline: {
                metric: true,
                feet: false,
                shapeOptions: {
                    color: '#23bfc2'
                },
            },
        },
        position: 'topright'
    });

    map.addControl(drawControl);
    map.addEventListener("draw:created", function (e) {
        drawnItems.clearLayers();
        let layer = e.layer;
        drawnItems.addLayer(layer);

        if (layer instanceof L.Polyline) {
            let distance = turf.length(layer.toGeoJSON(), { units: 'kilometers' });
            alert(`Distancia: ${distance.toFixed(2)} km`);
        } else if (layer instanceof L.Circle) {
            let lat = layer._latlng.lat;
            let lng = layer._latlng.lng;
            let radio = layer._mRadius / 1000; // Radio en kilómetros
            let area = Math.PI * Math.pow(radio, 2);
            alert(`Área: ${area.toFixed(2)} km²`);
        }

        // Mover el código de agregar marcadores aquí, dentro de la función .then()
        fetch("obtenerdatos/") // La URL de la vista Django para obtener datos desde la base de datos
            .then(function (response) {
                return response.json();
            })
            .then(function (misDatos) {
                // Agregar marcadores al mapa
                if (layer instanceof L.Circle) {
                    let lat = layer._latlng.lat;
                    let lng = layer._latlng.lng;
                    let radio = layer._mRadius;
                    let point = turf.point([lng, lat]);
                    let buffered = turf.buffer(point, radio / 1000, { units: 'kilometers' });
                    let ptsWithin = turf.pointsWithinPolygon(misDatos, buffered.geometry);
                    let cadena = ptsWithin.features;

                    cadena.forEach(function (feature) {
                        let latlng = L.latLng(feature.geometry.coordinates[1], feature.geometry.coordinates[0]);
                        L.marker(latlng).addTo(map);
                    });
                } else {
                    let geojson = layer.toGeoJSON().geometry;
                    let ptsWithin = turf.pointsWithinPolygon(misDatos, geojson);
                    let cadena = ptsWithin.features;

                    cadena.forEach(function (feature) {
                        let latlng = L.latLng(feature.geometry.coordinates[1], feature.geometry.coordinates[0]);
                        L.marker(latlng).addTo(map);
                    });

                    // Llenar la tabla DataTables
                    let lista = document.querySelector('#lista');
                    lista.innerHTML = '';
                    misDatos.forEach(function (item) {
                        lista.innerHTML += `
                            <tr>
                                <td>${item.cueanexo}</td>
                                <td>${item.nom_est}</td>
                                <td>${item.ambito}</td>
                                <td>${item.departamento}</td>
                                <td>${item.region_loc}</td>
                            </tr>`;
                    });

                    // Inicializar o actualizar DataTables después de llenar la tabla
                    $('#table').DataTable();
                }
            });
    });
</script>
</body>
</html>
  